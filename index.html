<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KAUÃ_OS // PWA_READY</title>
    
    <!-- PWA MANIFEST & ICONS (EMBEDDED) -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgZmlsbD0iIzAwMCIvPjxwYXRoIGQ9Ik05NiAxMjhsMTI4IDEyOC0xMjggMTI4TTI1NiAzODRoMTYwIiBzdHJva2U9IiMwMGZmNDEiIHN0cm9rZS13aWR0aD0iNDAiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgZmlsbD0ibm9uZSIvPjwvc3ZnPg==">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgZmlsbD0iIzAwMCIvPjxwYXRoIGQ9Ik05NiAxMjhsMTI4IDEyOC0xMjggMTI4TTI1NiAzODRoMTYwIiBzdHJva2U9IiMwMGZmNDEiIHN0cm9rZS13aWR0aD0iNDAiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgZmlsbD0ibm9uZSIvPjwvc3ZnPg==">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- PWA MANIFEST JSON (DATA URI) -->
    <link rel="manifest" href='data:application/manifest+json;base64,ewogICJuYW1lIjogIkthdSDDoyBPUyIsCiAgInNob3J0X25hbWUiOiAiS2F1w6NPUyIsCiAgInN0YXJ0X3VybCI6ICIuIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjMDAwMDAwIiwKICAidGhlbWVfY29xvciI6ICIjMDAwMDAwIiwKICAib3JpZW50YXRpb24iOiAicG9ydHJhaXQiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUI0Yld4dWN6MGlhSFIwY0RvdkwM2QzZHk1M015NXZjbWN2TWpBd01DOXpkbWNpSUhaaFpXdGRiM2c5SWpBd0lEQWdOVEV5TlRFeUlqNDhjbVZqZENCM2FXUjBhRDBpTlRFeSIgaGVpZ2h0PSI1MTIiIGZpbGw9IiMwMDAiLz48cGF0aCBkPSJNOTYgMTI4bDEyOCAxMjgtMTI4IDEyOE0yNTYgMzg0aDE2MCIgc3Ryb2tlPSIjMDBmZjQxIiBzdHJva2Utd2lkdGg9IjQwIiBzdHJva2UtbGluZWNhcD0icm91bmQiIGZpbGw9Im5vbmUiLz48L3N2Zz4iLAogICAgICAic2l6ZXMiOiAiNTEyeDUxMiIsCiAgICAgICJ0eXBlIjogImltYWdlL3N2Zyt4bWwiCiAgICB9CiAgXQp9'>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">

    <style>
        /* --- CORE VARIABLES --- */
        :root {
            --bg: #050505; --panel: #0a0a0a; --border: #333; --accent: #00ff41; --text: #e0e0e0;
            --danger: #ef4444; --warning: #f59e0b; --ai-color: #8b5cf6;
        }

        /* Themes */
        body.theme-matrix { --bg: #000; --panel: #020a02; --border: #003300; --accent: #00ff41; }
        body.theme-cyber { --bg: #050510; --panel: #0a0a1a; --border: #003366; --accent: #00f3ff; }
        body.theme-dracula { --bg: #282a36; --panel: #44475a; --border: #6272a4; --accent: #ff79c6; }
        body.theme-fire { --bg: #1a0500; --panel: #2a0a00; --border: #661a00; --accent: #ff4500; }
        body.theme-amber { --bg: #1a1200; --panel: #261a00; --border: #664d00; --accent: #ffb000; }
        body.theme-ocean { --bg: #001a1a; --panel: #002b2b; --border: #004d4d; --accent: #00e5ff; }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--bg); color: var(--text);
            font-family: 'Share Tech Mono', monospace;
            height: 100vh; width: 100vw; overflow: hidden;
            margin: 0; display: flex; justify-content: center; align-items: center;
            transition: background 0.5s, color 0.5s;
        }

        /* --- VISUAL FX --- */
        .scanlines {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), 
                        linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%; pointer-events: none; z-index: 10; opacity: 0.15;
        }

        /* Power & Panel Animations */
        .power-off { opacity: 0; filter: brightness(0) blur(4px); pointer-events: none; display: none; }
        .power-on { 
            opacity: 1; filter: brightness(1) blur(0); pointer-events: all; display: flex;
            animation: turnOn 0.6s ease-out forwards;
            box-shadow: 0 0 15px rgba(0,0,0,0.3);
        }
        @keyframes turnOn {
            0% { opacity: 0; transform: scaleY(0.01) scaleX(0); }
            50% { opacity: 1; transform: scaleY(0.01) scaleX(1); }
            100% { opacity: 1; transform: scaleY(1) scaleX(1); }
        }

        /* CRT Overlay */
        #crt-overlay {
            position: fixed; inset: 0; background: #000; z-index: 350;
            display: none; pointer-events: none;
        }
        .crt-flash {
            width: 100%; height: 100%; background: white; opacity: 0;
            animation: flash 0.2s ease-out;
        }
        @keyframes flash { 0% { opacity: 0.8; } 100% { opacity: 0; } }

        /* --- UI ELEMENTS --- */
        .btn {
            background: #111; border: 1px solid #333; color: #ccc;
            padding: 5px 12px; font-size: 11px; cursor: pointer; transition: 0.2s;
            display: flex; items-center; gap: 5px; border-radius: 3px;
        }
        .btn:hover { border-color: var(--accent); color: white; }
        .btn-ai { border-color: var(--ai-color); color: var(--ai-color); }
        .btn-ai:hover { background: var(--ai-color); color: white; }
        
        .ui-input {
            background: #050505; border: 1px solid #333; color: white; padding: 8px;
            font-family: 'Share Tech Mono'; outline: none; width: 100%;
        }
        .ui-input:focus { border-color: var(--accent); }

        /* --- MODALS --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 300;
            display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px);
        }
        .modal-box {
            background: var(--panel); border: 1px solid var(--accent); padding: 2px;
            width: 340px; max-height: 80vh; overflow-y: auto;
            box-shadow: 0 0 30px var(--accent); display: flex; flex-direction: column;
        }
        .modal-header { background: var(--accent); color: black; font-weight: bold; padding: 6px 12px; font-size: 12px; display: flex; justify-content: space-between; }
        .modal-body { padding: 15px; display: flex; flex-direction: column; gap: 10px; }

        /* --- CANVAS IDE --- */
        #immersive-canvas {
            position: fixed; inset: 0; z-index: 200; background: var(--bg);
            display: none; flex-direction: column; animation: slideUp 0.3s;
        }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .canvas-header { height: 50px; border-bottom: 1px solid var(--border); background: var(--panel); display: flex; align-items: center; justify-content: space-between; padding: 0 10px; overflow-x: auto;}
        .canvas-body { flex: 1; display: flex; overflow: hidden; position: relative; }
        
        .code-pane { flex: 1; display: flex; flex-direction: column; border-right: 1px solid var(--border); background: #080808; min-width: 300px; }
        .preview-pane { flex: 1; display: flex; flex-direction: column; background: #fff; position: relative; }
        
        #editor-area { flex: 1; background: transparent; color: #d4d4d4; border: none; outline: none; padding: 20px; font-family: 'Fira Code', monospace; font-size: 13px; resize: none; line-height: 1.5; white-space: pre; }
        
        #web-preview { width: 100%; height: 100%; border: none; background: white; }
        #console-view { width: 100%; height: 100%; background: #111; color: var(--accent); font-family: 'Fira Code', monospace; padding: 15px; overflow-y: auto; display: none; font-size: 13px; }
        
        /* Fullscreen Preview */
        .preview-pane.fullscreen { position: fixed; inset: 0; z-index: 300; width: 100% !important; height: 100% !important; }
        .fs-exit-btn { display: none; position: absolute; top: 10px; right: 10px; background: red; color: white; padding: 8px 15px; cursor: pointer; z-index: 310; font-weight: bold; border-radius: 4px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .preview-pane.fullscreen .fs-exit-btn { display: block; }

        /* Key Feedback */
        .key { background: #111; border: 1px solid #333; border-radius: 4px; display:flex; justify-content:center; align-items:center; cursor:pointer; font-size:12px; color:#666; transition: 0.05s; touch-action: manipulation; }
        .key.active { background: var(--accent); color: black; box-shadow: 0 0 15px var(--accent); transform: scale(0.95); }

        /* --- DESKTOP GRID --- */
        #desktop-grid {
            display: grid; width: 100%; height: 100%; padding: 6px; gap: 6px;
            grid-template-columns: 260px 1fr 260px; 
            grid-template-rows: 50px 1fr 240px; 
            opacity: 0; transition: opacity 0.5s;
        }

        .panel { background: var(--panel); border: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .panel-header { background: #000; padding: 6px 10px; font-size: 11px; text-transform: uppercase; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; color: #666; }

        /* --- MOBILE MODE ADJUSTMENTS --- */
        body.mobile-mode #desktop-grid {
            display: flex; flex-direction: column; gap: 2px; padding: 2px;
        }
        body.mobile-mode .panel { display: none; flex: 1; }
        body.mobile-mode #p-header { display: flex; flex: 0 0 50px; }
        body.mobile-mode #p-keyboard { display: flex; flex: 0 0 200px; }
        body.mobile-mode .panel.active-panel { display: flex; }

        body.mobile-mode .canvas-body { flex-direction: column; }
        body.mobile-mode .code-pane { border-right: none; border-bottom: 1px solid var(--border); height: 50%; width: 100%; min-width: 0; }
        body.mobile-mode .preview-pane { height: 50%; width: 100%; }

        .mobile-nav { display: none; gap: 5px; }
        body.mobile-mode .mobile-nav { display: flex; }
        .m-nav-btn {
            padding: 4px 8px; border: 1px solid var(--border); color: #666; font-size: 10px; cursor: pointer;
        }
        .m-nav-btn.active { background: var(--accent); color: black; border-color: var(--accent); }

        /* Toast */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 600; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: #111; border: 1px solid var(--accent); color: white; padding: 10px 20px; font-size: 12px; border-radius: 4px; box-shadow: 0 0 15px var(--accent); animation: slideIn 0.3s ease-out; display: flex; align-items: center; gap: 10px; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* Start Overlay */
        #start-overlay { position: fixed; inset: 0; background: #000; z-index: 400; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .device-selector { display: flex; gap: 20px; margin-top: 20px; }
        .device-btn {
            border: 1px solid var(--border); padding: 15px 30px; color: var(--text); cursor: pointer;
            transition: 0.3s; display: flex; flex-direction: column; align-items: center; gap: 10px;
        }
        .device-btn:hover { border-color: var(--accent); color: var(--accent); box-shadow: 0 0 20px rgba(0,255,65,0.2); }
        .device-icon { width: 32px; height: 32px; }

        #boot-logs { text-align: left; font-family: 'Fira Code', monospace; width: 300px; height: 150px; overflow: hidden; display: none; flex-direction: column; justify-content: flex-end; margin-top: 20px; }
        .log-line { font-size: 10px; color: var(--accent); margin-bottom: 2px; }

    </style>
</head>
<body class="theme-matrix">

    <div class="scanlines"></div>
    <div id="toast-container"></div>
    <div id="crt-overlay"><div class="crt-flash"></div></div>

    <!-- START SCREEN -->
    <div id="start-overlay">
        <div id="start-content" class="flex flex-col items-center">
            <div class="text-5xl font-bold text-white mb-2 tracking-tighter">KAUÃ_OS</div>
            <div class="text-xs text-gray-500 tracking-[0.5em] mb-8">BOOTLOADER V21.0 (PWA)</div>
            
            <div class="text-sm text-gray-400 mb-4">SELECIONE O MODO:</div>
            <div class="device-selector">
                <div class="device-btn" onclick="OS.selectMode('desktop')">
                    <i data-lucide="monitor" class="device-icon"></i>
                    <span>PC</span>
                </div>
                <div class="device-btn" onclick="OS.selectMode('mobile')">
                    <i data-lucide="smartphone" class="device-icon"></i>
                    <span>MOBILE</span>
                </div>
            </div>
        </div>
        <div id="boot-logs"></div>
    </div>

    <!-- IDE CANVAS -->
    <div id="immersive-canvas">
        <div class="canvas-header">
            <div class="flex items-center gap-2 flex-1 overflow-hidden">
                <div class="font-bold text-[var(--accent)] text-xs md:text-sm">IDE</div>
                <div class="tabs-container" id="tabs-bar"></div>
                <button class="btn" onclick="UI.openModal('modal-new')">+</button>
            </div>
            
            <div class="flex items-center gap-2">
                <button class="btn btn-ai hidden md:flex" onclick="AI.smartFormat()">
                    <i data-lucide="wand-2" class="w-3 h-3"></i> <span class="hidden md:inline">CORRIGIR</span>
                </button>
                <button class="btn btn-primary" onclick="Canvas.run()">
                    <i data-lucide="play" class="w-3 h-3"></i>
                </button>
                <button class="btn" onclick="Canvas.toggleFullscreen()">
                    <i data-lucide="maximize" class="w-3 h-3"></i>
                </button>
                <button class="btn" onclick="Canvas.close()">X</button>
            </div>
        </div>

        <div class="canvas-body">
            <div class="code-pane">
                <textarea id="editor-area" spellcheck="false" placeholder="// Escreva seu código..."></textarea>
            </div>
            
            <div class="preview-pane" id="preview-container">
                <button class="fs-exit-btn" onclick="Canvas.toggleFullscreen()">SAIR DA TELA CHEIA</button>
                <iframe id="web-preview"></iframe>
                <div id="console-view">
                    <div class="opacity-50 mb-2">// CONSOLE OUTPUT</div>
                    <div id="console-logs"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN DESKTOP -->
    <div id="desktop-grid">
        <!-- Header -->
        <div class="panel power-off" id="p-header" style="grid-column: 1 / -1; grid-row: 1;">
            <div class="flex items-center justify-between h-full px-2 md:px-4">
                <div class="font-bold flex items-center gap-2 text-sm md:text-lg">
                    KAUÃ_OS <span class="text-[10px] border border-[var(--accent)] px-1 rounded text-[var(--accent)]">V21</span>
                </div>
                
                <div class="mobile-nav">
                    <div class="m-nav-btn active" onclick="OS.switchMobileTab('term')">TERM</div>
                    <div class="m-nav-btn" onclick="OS.switchMobileTab('files')">ARQ</div>
                    <div class="m-nav-btn" onclick="OS.switchMobileTab('sys')">SYS</div>
                    <div class="m-nav-btn" onclick="OS.switchMobileTab('net')">REDE</div>
                </div>

                <div class="flex gap-4 items-center">
                    <button onclick="UI.openModal('modal-settings')" class="text-[10px] hover:text-[var(--accent)] hidden md:block">OPÇÕES</button>
                    <div id="clock" class="text-xs md:text-sm font-mono text-gray-500">00:00</div>
                </div>
            </div>
        </div>

        <!-- Left System -->
        <div class="panel power-off" id="p-left" style="grid-column: 1; grid-row: 2 / 4;">
            <div class="panel-header">SISTEMA</div>
            <div class="p-4 flex flex-col gap-4 h-full">
                <div class="border border-[var(--border)] p-2 rounded bg-black">
                    <div class="flex justify-between text-xs mb-1"><span>CPU</span><span id="cpu-val">12%</span></div>
                    <div class="w-full bg-[#111] h-2 rounded overflow-hidden">
                        <div id="cpu-bar" class="h-full bg-[var(--accent)] w-12% transition-all"></div>
                    </div>
                </div>
                <div class="border border-[var(--border)] p-2 rounded bg-black">
                    <div class="flex justify-between text-xs mb-1"><span>RAM</span><span id="ram-val">4.2GB</span></div>
                    <div class="w-full bg-[#111] h-2 rounded overflow-hidden">
                        <div id="ram-bar" class="h-full bg-blue-500 w-60% animate-pulse"></div>
                    </div>
                </div>
                <div class="mt-auto text-[10px] text-gray-500">
                    <div class="flex items-center gap-2"><div class="w-2 h-2 bg-green-500 rounded-full"></div> FIREWALL: ON</div>
                </div>
            </div>
        </div>

        <!-- Center Terminal -->
        <div class="panel power-off active-panel" id="p-center" style="grid-column: 2; grid-row: 2;">
            <div class="panel-header">TERMINAL</div>
            <div id="term-out" class="font-mono text-xs p-2 text-gray-300 overflow-y-auto h-full"></div>
            <div class="bg-black p-2 flex items-center border-t border-[var(--border)]">
                <span style="color:var(--accent)" class="mr-2 font-bold">root@kaua:~$</span>
                <input id="cmd-input" type="text" class="bg-transparent border-none outline-none text-white flex-1 font-mono" autocomplete="off">
            </div>
        </div>

        <!-- Right Network -->
        <div class="panel power-off" id="p-right" style="grid-column: 3; grid-row: 2;">
            <div class="panel-header">REDE</div>
            <div class="flex-1 bg-black flex items-center justify-center relative overflow-hidden" id="net-container">
                <canvas id="globe-canvas"></canvas>
            </div>
        </div>

        <!-- Files -->
        <div class="panel power-off" id="p-files" style="grid-column: 2; grid-row: 3; width: 40%; float: left; margin-right: 5px;">
            <div class="panel-header">ARQUIVOS <span onclick="UI.openModal('modal-new')" class="cursor-pointer hover:text-white">+</span></div>
            <div id="file-grid" class="p-2 grid grid-cols-4 gap-2 content-start overflow-y-auto h-full"></div>
        </div>

        <!-- Keyboard -->
        <div class="panel power-off" id="p-keyboard" style="grid-column: 2 / 4; grid-row: 3; width: auto; margin-left: 41%;">
            <div class="panel-header">
                TECLADO 
                <i data-lucide="volume-2" id="kb-mute-btn" class="w-3 h-3 cursor-pointer hover:text-white" onclick="AudioSys.toggleMute()"></i>
            </div>
            <div id="kb-container" class="p-2 h-full flex flex-col justify-center gap-1"></div>
        </div>
    </div>

    <!-- MODALS -->
    <div id="modal-new" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">NOVO ARQUIVO <span onclick="UI.closeModal('modal-new')" class="cursor-pointer">X</span></div>
            <div class="modal-body">
                <input type="text" id="new-filename" class="ui-input" placeholder="Nome (ex: app.js)">
                <div class="grid grid-cols-2 gap-2 mt-2">
                    <button class="ui-btn" onclick="OS.createFile('html')">HTML</button>
                    <button class="ui-btn" onclick="OS.createFile('js')">JS</button>
                    <button class="ui-btn" onclick="OS.createFile('py')">PYTHON</button>
                    <button class="ui-btn" onclick="OS.createFile('txt')">TXT</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-settings" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">CONFIGURAÇÕES <span onclick="UI.closeModal('modal-settings')" class="cursor-pointer">X</span></div>
            <div class="modal-body">
                <button class="ui-btn" onclick="UI.setTheme('theme-matrix')">Matrix Green</button>
                <button class="ui-btn" onclick="UI.setTheme('theme-cyber')">Cyber Blue</button>
                <button class="ui-btn" onclick="UI.setTheme('theme-dracula')">Dracula</button>
                <button class="ui-btn" onclick="FS.exportZip()">DOWNLOAD ZIP</button>
                <button class="ui-btn" style="color:var(--danger)" onclick="FS.reset()">RESETAR</button>
            </div>
        </div>
    </div>

    <script>
        // --- AUDIO SYSTEM V5 (Mobile Fix) ---
        const AudioSys = {
            ctx: null, profile: 'mech', muted: false,
            init() { 
                window.AudioContext = window.AudioContext || window.webkitAudioContext; 
                this.ctx = new AudioContext(); 
            },
            toggleMute() {
                this.muted = !this.muted;
                const btn = document.getElementById('kb-mute-btn');
                if(btn) {
                    btn.setAttribute('data-lucide', this.muted ? 'volume-x' : 'volume-2');
                    btn.classList.toggle('text-red-500', this.muted);
                    lucide.createIcons();
                }
            },
            playStartup() {
                if(!this.ctx) this.init();
                if(this.ctx.state === 'suspended') this.ctx.resume();
                if(this.muted) return;
                
                const now = this.ctx.currentTime;
                [220, 330, 440, 550, 660, 880].forEach((freq, i) => {
                    const osc = this.ctx.createOscillator();
                    const gain = this.ctx.createGain();
                    osc.type = 'sawtooth';
                    osc.frequency.value = freq;
                    osc.connect(gain); gain.connect(this.ctx.destination);
                    gain.gain.setValueAtTime(0, now + i*0.1);
                    gain.gain.linearRampToValueAtTime(0.05, now + i*0.1 + 0.05);
                    gain.gain.exponentialRampToValueAtTime(0.001, now + i*0.1 + 0.3);
                    osc.start(now + i*0.1); osc.stop(now + i*0.1 + 0.35);
                });
            },
            play(type) {
                if(!this.ctx || this.ctx.state === 'suspended') this.ctx?.resume();
                if(this.muted && type === 'type') return;
                
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.connect(gain); gain.connect(this.ctx.destination);
                const t = this.ctx.currentTime;

                osc.type = type === 'enter' ? 'square' : 'triangle';
                osc.frequency.setValueAtTime(type==='enter'?600:800, t);
                gain.gain.exponentialRampToValueAtTime(0.001, t + 0.05);
                osc.start(t); osc.stop(t + 0.05);
            }
        };

        // --- AI SMART FORMATTER ---
        const AI = {
            smartFormat() {
                const editor = document.getElementById('editor-area');
                let code = editor.value;
                const ext = Canvas.activeTab.split('.').pop();
                
                if (ext === 'html') {
                    if(!code.toLowerCase().includes('<!doctype html>')) code = '<!DOCTYPE html>\n' + code;
                    const openDivs = (code.match(/<div/g) || []).length;
                    const closeDivs = (code.match(/<\/div>/g) || []).length;
                    if(openDivs > closeDivs) code += '\n' + '</div>'.repeat(openDivs - closeDivs);
                    // Safe string literal for script tag
                    if (code.includes('<script') && !code.includes('<' + '/script>')) code += '\n<' + '/script>';
                }
                
                editor.value = code;
                Canvas.run();
                UI.toast("Código formatado.", "info");
            }
        };

        // --- CANVAS LOGIC ---
        const Canvas = {
            activeTab: null,
            openTabs: [],
            
            open(filename) {
                if(!this.openTabs.includes(filename)) this.openTabs.push(filename);
                this.activeTab = filename;
                document.getElementById('immersive-canvas').style.display = 'flex';
                this.renderTabs();
                this.load();
                this.setView('preview');
            },
            
            close() {
                document.getElementById('immersive-canvas').style.display = 'none';
                if(this.activeTab && FS.files[this.activeTab]) {
                    FS.files[this.activeTab].content = document.getElementById('editor-area').value;
                    FS.save();
                }
            },

            load() {
                const f = FS.files[this.activeTab];
                if(f) document.getElementById('editor-area').value = f.content;
                this.run();
            },

            run() {
                const code = document.getElementById('editor-area').value;
                const iframe = document.getElementById('web-preview');
                const consoleDiv = document.getElementById('console-logs');
                
                if(this.activeTab) { FS.files[this.activeTab].content = code; FS.save(); }

                consoleDiv.innerHTML = '';
                iframe.src = 'about:blank';
                
                setTimeout(() => {
                    const doc = iframe.contentWindow.document;
                    doc.open();
                    
                    if(this.activeTab.endsWith('.html')) {
                        doc.write(`
                            <style>body{color:#000; background:#fff; font-family:sans-serif;}</style>
                            <script>
                                console.log = function(m){ window.parent.postMessage({type:'log', msg:m}, '*'); }
                                window.onerror = function(m){ window.parent.postMessage({type:'error', msg:m}, '*'); }
                            <` + `/script>
                            ${code}
                        `);
                    } else {
                        this.setView('console');
                        try {
                            if(this.activeTab.endsWith('.js')) {
                                new Function('console', code)({ log: (m) => consoleDiv.innerHTML += `<div class="text-green-400">> ${m}</div>` });
                            } else {
                                consoleDiv.innerHTML += `<div class="text-blue-400">> Execução de ${this.activeTab} simulada.</div>`;
                            }
                        } catch(e) {
                            consoleDiv.innerHTML += `<div class="text-red-500">Erro: ${e.message}</div>`;
                        }
                    }
                    doc.close();
                }, 50);
            },

            setView(mode) {
                const web = document.getElementById('web-preview');
                const cons = document.getElementById('console-view');
                if(mode === 'preview') { web.style.display='block'; cons.style.display='none'; }
                else { web.style.display='none'; cons.style.display='block'; }
            },

            renderTabs() {
                const c = document.getElementById('tabs-bar'); c.innerHTML = '';
                this.openTabs.forEach(t => {
                    const el = document.createElement('div');
                    el.className = `tab ${t===this.activeTab?'active':''}`;
                    el.innerHTML = `${t} <span class="ml-2 hover:text-red-500" onclick="Canvas.closeTab('${t}', event)">x</span>`;
                    el.onclick = () => { this.activeTab = t; this.load(); this.renderTabs(); };
                    c.appendChild(el);
                });
            },

            closeTab(t, e) {
                e.stopPropagation();
                this.openTabs = this.openTabs.filter(x => x !== t);
                if(this.openTabs.length === 0) this.close();
                else if(this.activeTab === t) { this.activeTab = this.openTabs[0]; this.load(); }
                this.renderTabs();
            },

            toggleFullscreen() {
                document.getElementById('preview-container').classList.toggle('fullscreen');
            }
        };

        window.addEventListener('message', e => {
            const logs = document.getElementById('console-logs');
            if(e.data.type === 'log') logs.innerHTML += `<div class="text-green-400 border-b border-[#222]">> ${e.data.msg}</div>`;
            if(e.data.type === 'error') logs.innerHTML += `<div class="text-red-500 border-b border-[#222]">! ${e.data.msg}</div>`;
        });

        // --- OS & FILES ---
        const FS = {
            files: {},
            init() {
                try {
                    const s = localStorage.getItem('kaua_files');
                    this.files = s ? JSON.parse(s) : { 'index.html': { type: 'web', content: '<h1>Ola!</h1>' } };
                } catch { this.files = {}; }
            },
            save() { localStorage.setItem('kaua_files', JSON.stringify(this.files)); UI.renderFiles(); },
            add(n, t, c) { this.files[n] = {type:t, content:c}; this.save(); },
            reset() { localStorage.removeItem('kaua_files'); location.reload(); },
            exportZip() { 
                const z = new JSZip();
                Object.keys(this.files).forEach(k => z.file(k, this.files[k].content));
                z.generateAsync({type:"blob"}).then(b => {
                    const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download="project.zip"; a.click();
                });
            }
        };

        const OS = {
            isMobile: false,
            selectMode(mode) {
                this.isMobile = (mode === 'mobile');
                if(this.isMobile) document.body.classList.add('mobile-mode');
                this.bootSequence();
            },
            bootSequence() {
                document.getElementById('start-content').style.display = 'none';
                const log = document.getElementById('boot-logs');
                log.style.display = 'flex';
                AudioSys.playStartup();
                
                let steps = ["Kernel Init...", "Device Check...", "Configuring UI...", "Starting System..."];
                let i = 0;
                let int = setInterval(() => {
                    if(i >= steps.length) {
                        clearInterval(int);
                        document.getElementById('crt-overlay').style.display = 'block';
                        setTimeout(() => {
                            document.getElementById('start-overlay').style.display='none';
                            document.getElementById('desktop-grid').style.opacity = 1;
                            
                            // Initialize Layout for Mobile
                            if(this.isMobile) {
                                document.getElementById('p-left').classList.remove('active-panel'); 
                                document.getElementById('p-right').classList.remove('active-panel');
                                document.getElementById('p-files').classList.remove('active-panel');
                                document.getElementById('p-center').classList.add('active-panel'); 
                            }

                            document.querySelectorAll('.power-off').forEach(e => {
                                if(!this.isMobile || e.classList.contains('active-panel') || e.id === 'p-header' || e.id === 'p-keyboard') {
                                    e.classList.remove('power-off'); e.classList.add('power-on');
                                } else {
                                    e.classList.remove('power-off'); 
                                }
                            });
                            document.getElementById('crt-overlay').style.display = 'none';
                        }, 500);
                        return;
                    }
                    log.innerHTML += `<div class="log-line">> ${steps[i]}</div>`;
                    i++;
                }, 400);
            },
            switchMobileTab(tab) {
                document.querySelectorAll('.panel').forEach(p => {
                    if(p.id !== 'p-header' && p.id !== 'p-keyboard') p.classList.remove('active-panel');
                });
                document.querySelectorAll('.m-nav-btn').forEach(b => b.classList.remove('active'));

                const map = { 'term': 'p-center', 'files': 'p-files', 'sys': 'p-left', 'net': 'p-right' };
                document.getElementById(map[tab]).classList.add('active-panel');
                
                const btnIndex = Object.keys(map).indexOf(tab);
                document.querySelectorAll('.m-nav-btn')[btnIndex].classList.add('active');
            },
            createFile(ext) {
                const n = document.getElementById('new-filename').value || 'untitled';
                FS.add(n+'.'+ext, 'code', '');
                UI.closeModal('modal-new');
                Canvas.open(n+'.'+ext);
            }
        };

        const UI = {
            init() {
                this.renderFiles();
                this.renderKeys('kb-container');
                this.startGlobe();
                const t = localStorage.getItem('kaua_theme');
                if(t) document.body.className = t;
            },
            renderFiles() {
                const g = document.getElementById('file-grid'); g.innerHTML='';
                Object.keys(FS.files).forEach(f => {
                    const d = document.createElement('div');
                    d.className="flex flex-col items-center cursor-pointer hover:bg-white/10 p-2 rounded text-[10px] text-gray-400";
                    d.innerHTML=`<i data-lucide="file-code" class="w-5 h-5 mb-1"></i>${f}`;
                    d.onclick = () => Canvas.open(f);
                    g.appendChild(d);
                });
                lucide.createIcons();
            },
            renderKeys(containerId) {
                const c = document.getElementById(containerId); c.innerHTML = '';
                ["1234567890","QWERTYUIOP","ASDFGHJKL","ZXCVBNM"].forEach(r => {
                    const d = document.createElement('div'); d.className="flex gap-1 justify-center w-full mb-1";
                    r.split('').forEach(c => {
                        const key = document.createElement('div');
                        key.className = "key flex-1 h-8"; key.innerText = c; key.dataset.key = c;
                        
                        // FIX: ADD TOUCHSTART EVENT
                        const trigger = (e) => {
                            if(e.type === 'touchstart') e.preventDefault(); // Stop double-firing
                            const active = document.activeElement.tagName==='TEXTAREA'?document.activeElement:document.getElementById('cmd-input');
                            active.value += c; 
                            // Only focus if not on mobile to prevent native keyboard? No, let's keep consistent.
                            // The issue user reported was sound not working.
                            // Audio play is now inside trigger.
                            AudioSys.play('type');
                            key.classList.add('active'); 
                            setTimeout(()=>key.classList.remove('active'), 100);
                        };

                        key.addEventListener('mousedown', trigger);
                        key.addEventListener('touchstart', trigger); // CRITICAL FOR MOBILE AUDIO
                        
                        d.appendChild(key);
                    });
                    c.appendChild(d);
                });
                // Spacebar
                const sp = document.createElement('div'); sp.className="flex justify-center";
                const spKey = document.createElement('div');
                spKey.className = "key w-1/2 h-8";
                spKey.innerText = "SPACE";
                spKey.dataset.key = "SPACE";
                
                const triggerSp = (e) => {
                    if(e.type === 'touchstart') e.preventDefault();
                    document.getElementById('cmd-input').value+=' ';
                    AudioSys.play('type');
                    spKey.classList.add('active');
                    setTimeout(()=>spKey.classList.remove('active'), 100);
                }
                spKey.addEventListener('mousedown', triggerSp);
                spKey.addEventListener('touchstart', triggerSp);
                
                sp.appendChild(spKey);
                c.appendChild(sp);
            },
            openModal(id) { document.getElementById(id).style.display = 'flex'; },
            closeModal(id) { document.getElementById(id).style.display = 'none'; },
            setTheme(t) { 
                document.body.className = t; 
                if(OS.isMobile) document.body.classList.add('mobile-mode'); // Preserve mobile mode class
                localStorage.setItem('kaua_theme', t); 
                this.closeModal('modal-settings'); 
            },
            startGlobe() {
                const c = document.getElementById('globe-canvas'); const ctx = c.getContext('2d');
                let t=0;
                function loop() {
                    if(!c.offsetParent) return requestAnimationFrame(loop);
                    c.width = c.parentElement.offsetWidth; c.height = c.parentElement.offsetHeight;
                    ctx.fillStyle='black'; ctx.fillRect(0,0,c.width,c.height);
                    t+=0.02; ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--accent');
                    for(let i=0;i<60;i++) {
                        const a = (i/60)*6.28+t;
                        const x = Math.cos(a)*40 + c.width/2;
                        const y = Math.sin(a)*10 + c.height/2;
                        ctx.beginPath(); ctx.arc(x,y,2,0,6.28); ctx.fill();
                    }
                    requestAnimationFrame(loop);
                }
                loop();
            },
            toast(m, t) {
                const c = document.getElementById('toast-container');
                const d = document.createElement('div'); d.className='toast';
                d.innerHTML = `<i data-lucide="${t==='success'?'check':'info'}" class="w-4 h-4"></i> ${m}`;
                c.appendChild(d); lucide.createIcons(); setTimeout(()=>d.remove(),3000);
            }
        };

        // Key Listener
        window.addEventListener('keydown', e => {
            const k = document.querySelector(`.key[data-key="${e.key.toUpperCase()}"]`);
            if(k) { k.classList.add('active'); setTimeout(()=>k.classList.remove('active'),150); AudioSys.play('type'); }
            
            if(e.key === 'Enter' && document.activeElement.id === 'cmd-input') {
                const v = document.getElementById('cmd-input').value;
                document.getElementById('term-out').innerHTML += `<div>root:~$ ${v}</div>`;
                if(v.startsWith('code')) { const f=v.split(' ')[1]; if(f) Canvas.open(f); }
                document.getElementById('cmd-input').value=''; AudioSys.play('type');
            }
        });

        // Loop
        setInterval(() => {
            document.getElementById('clock').innerText = new Date().toLocaleTimeString();
            document.getElementById('cpu-val').innerText = Math.floor(Math.random()*30+10)+"%";
            document.getElementById('cpu-bar').style.width = document.getElementById('cpu-val').innerText;
        }, 1000);

        // Init
        FS.init(); UI.init();

    </script>
</body>
</html>
