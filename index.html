<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KAUÃ_OS // V26_MOBILE_FIX</title>
    
    <!-- PWA META TAGS -->
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Kauã OS">

    <!-- ICONS -->
    <link rel="icon" id="favicon" type="image/png" href="">
    <link rel="apple-touch-icon" id="apple-icon" href="">
    
    <!-- LIBS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">

    <!-- PWA INJECTOR -->
    <script>
        (function() {
            try {
                const iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><rect width="512" height="512" fill="#000"/><path d="M64 128l128 128-128 128M256 384h192" stroke="#00ff41" stroke-width="60" stroke-linecap="round" fill="none"/></svg>`;
                const iconUrl = "data:image/svg+xml;base64," + btoa(iconSvg);
                const fav = document.getElementById('favicon');
                const apple = document.getElementById('apple-icon');
                if(fav) fav.href = iconUrl;
                if(apple) apple.href = iconUrl;

                const manifest = {
                    "name": "Kauã OS", "short_name": "KauãOS", "start_url": ".", "display": "standalone",
                    "background_color": "#000000", "theme_color": "#000000", "orientation": "portrait",
                    "icons": [{ "src": iconUrl, "sizes": "192x192", "type": "image/svg+xml", "purpose": "any maskable" }]
                };
                const blob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
                const link = document.createElement('link');
                link.rel = 'manifest'; link.href = URL.createObjectURL(blob);
                document.head.appendChild(link);

                if ('serviceWorker' in navigator && window.location.protocol !== 'blob:') {
                    const swCode = "self.addEventListener('install', (e) => self.skipWaiting()); self.addEventListener('fetch', (e) => {});";
                    const swUrl = URL.createObjectURL(new Blob([swCode], {type: 'application/javascript'}));
                    navigator.serviceWorker.register(swUrl).catch(() => {});
                }
            } catch(e) {}
        })();
    </script>

    <style>
        :root { --bg: #050505; --panel: #0a0a0a; --border: #333; --accent: #00ff41; --text: #e0e0e0; --danger: #ef4444; --ai-color: #8b5cf6; }
        body.theme-matrix { --bg: #000; --panel: #020a02; --border: #003300; --accent: #00ff41; }
        body.theme-cyber { --bg: #050510; --panel: #0a0a1a; --border: #003366; --accent: #00f3ff; }
        body.theme-dracula { --bg: #282a36; --panel: #44475a; --border: #6272a4; --accent: #ff79c6; }
        body.theme-fire { --bg: #1a0500; --panel: #2a0a00; --border: #661a00; --accent: #ff4500; }
        
        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg); color: var(--text); font-family: 'Share Tech Mono', monospace; height: 100vh; width: 100vw; overflow: hidden; margin: 0; display: flex; justify-content: center; align-items: center; transition: background 0.5s; }

        .scanlines { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(rgba(18,16,16,0) 50%, rgba(0,0,0,0.25) 50%), linear-gradient(90deg, rgba(255,0,0,0.06), rgba(0,255,0,0.02), rgba(0,0,255,0.06)); background-size: 100% 2px, 3px 100%; pointer-events: none; z-index: 10; opacity: 0.15; }
        
        /* Animations */
        .power-off { opacity: 0; filter: brightness(0) blur(4px); pointer-events: none; display: none; }
        .power-on { opacity: 1; filter: brightness(1) blur(0); pointer-events: all; display: flex; animation: turnOn 0.6s ease-out forwards; box-shadow: 0 0 15px rgba(0,0,0,0.3); }
        @keyframes turnOn { 0% { opacity: 0; transform: scaleY(0.01) scaleX(0); } 100% { opacity: 1; transform: scaleY(1) scaleX(1); } }
        
        /* UI Components */
        .btn { background: #111; border: 1px solid #333; color: #ccc; padding: 5px 10px; font-size: 11px; cursor: pointer; display: flex; items-center; gap: 5px; border-radius: 3px; }
        .btn:hover { border-color: var(--accent); color: white; }
        .ui-input { background: #050505; border: 1px solid #333; color: white; padding: 8px; width: 100%; outline: none; font-family: 'Share Tech Mono'; }
        .ui-input:focus { border-color: var(--accent); }

        /* Modals */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 300; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal-box { background: var(--panel); border: 1px solid var(--accent); padding: 2px; width: 340px; max-height: 80vh; overflow-y: auto; box-shadow: 0 0 30px var(--accent); display: flex; flex-direction: column; }
        .modal-header { background: var(--accent); color: black; font-weight: bold; padding: 6px 12px; font-size: 12px; display: flex; justify-content: space-between; }
        .modal-body { padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .ui-btn { background: #111; border: 1px solid #333; color: #ccc; padding: 8px; cursor: pointer; text-align: left; display: flex; align-items: center; gap: 8px; font-size: 12px; }
        .ui-btn:hover { border-color: var(--accent); color: white; padding-left: 12px; transition: 0.2s; }

        /* Canvas IDE */
        #immersive-canvas { position: fixed; inset: 0; z-index: 200; background: var(--bg); display: none; flex-direction: column; animation: slideUp 0.3s; }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .canvas-header { height: 50px; border-bottom: 1px solid var(--border); background: var(--panel); display: flex; align-items: center; justify-content: space-between; padding: 0 10px; }
        .canvas-body { flex: 1; display: flex; overflow: hidden; position: relative; }
        .code-pane { flex: 1; display: flex; flex-direction: column; border-right: 1px solid var(--border); background: #080808; min-width: 0; }
        .preview-pane { flex: 1; display: flex; flex-direction: column; background: #fff; position: relative; }
        #editor-area { flex: 1; background: transparent; color: #d4d4d4; border: none; outline: none; padding: 15px; font-family: 'Fira Code', monospace; font-size: 13px; resize: none; }
        #web-preview { width: 100%; height: 100%; border: none; background: white; }
        #console-view { width: 100%; height: 100%; background: #111; color: var(--accent); font-family: 'Fira Code', monospace; padding: 15px; overflow-y: auto; display: none; font-size: 13px; }
        .preview-pane.fullscreen { position: fixed; inset: 0; z-index: 300; width: 100% !important; height: 100% !important; }
        .fs-exit-btn { display: none; position: absolute; top: 10px; right: 10px; background: red; color: white; padding: 5px 10px; cursor: pointer; z-index: 310; font-weight: bold; border-radius: 3px; }
        .preview-pane.fullscreen .fs-exit-btn { display: block; }

        /* Grid System */
        #desktop-grid { display: grid; width: 100%; height: 100%; padding: 6px; gap: 6px; grid-template-columns: 260px 1fr 260px; grid-template-rows: 50px 1fr 240px; opacity: 0; }
        .panel { background: var(--panel); border: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .panel-header { background: #000; padding: 6px 10px; font-size: 11px; text-transform: uppercase; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; color: #666; }

        /* File Grid Spacing Fix */
        #file-grid { gap: 15px; padding: 10px; } /* Increased gap for mobile */

        /* Mobile specific */
        body.mobile-mode #desktop-grid { display: flex; flex-direction: column; gap: 2px; padding: 2px; }
        body.mobile-mode .panel { display: none; flex: 1; }
        body.mobile-mode #p-header { display: flex; flex: 0 0 50px; }
        body.mobile-mode #p-keyboard { display: flex; flex: 0 0 220px; }
        body.mobile-mode .panel.active-panel { display: flex; }
        body.mobile-mode .canvas-body { flex-direction: column; }
        body.mobile-mode .code-pane { border-right: none; border-bottom: 1px solid var(--border); height: 50%; width: 100%; }
        body.mobile-mode .preview-pane { height: 50%; width: 100%; }
        /* 3 Columns for files on mobile */
        body.mobile-mode #file-grid { grid-template-columns: repeat(3, 1fr); }
        
        .mobile-nav { display: none; gap: 5px; }
        body.mobile-mode .mobile-nav { display: flex; }
        .m-nav-btn { padding: 4px 8px; border: 1px solid var(--border); color: #666; font-size: 10px; cursor: pointer; }
        .m-nav-btn.active { background: var(--accent); color: black; border-color: var(--accent); }

        /* Keyboard */
        .key { background: #111; border: 1px solid #333; border-radius: 4px; display:flex; justify-content:center; align-items:center; cursor:pointer; font-size:12px; color:#666; transition: 0.05s; touch-action: manipulation; -webkit-user-select: none; user-select: none; }
        /* Ensure active state works visually even on touch */
        .key.active { background: var(--accent) !important; color: black !important; box-shadow: 0 0 15px var(--accent); transform: scale(0.95); border-color: white; }
        #term-out { flex: 1; padding: 10px; overflow-y: auto; color: #ccc; font-size: 13px; }

        /* Start Overlay */
        #start-overlay { position: fixed; inset: 0; background: #000; z-index: 400; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .device-btn { border: 1px solid var(--border); padding: 15px 30px; color: var(--text); cursor: pointer; transition: 0.3s; display: flex; flex-direction: column; align-items: center; gap: 10px; margin: 0 10px; }
        .device-btn:hover { border-color: var(--accent); color: var(--accent); box-shadow: 0 0 20px rgba(0,255,65,0.2); }
        #install-btn { display: none; margin-top: 20px; background: var(--accent); color: black; font-weight: bold; border: none; padding: 10px 20px; cursor: pointer; }
        
        /* Toast */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 600; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: #111; border: 1px solid var(--accent); color: white; padding: 10px 20px; font-size: 12px; border-radius: 4px; box-shadow: 0 0 15px var(--accent); animation: slideIn 0.3s; display: flex; align-items: center; gap: 10px; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        /* File Deletion Button */
        .file-del-btn { display: none; position: absolute; top: -5px; right: -5px; color: red; background: black; border-radius: 50%; padding: 2px; }
        .file-item:hover .file-del-btn { display: block; }
        body.mobile-mode .file-del-btn { display: block; opacity: 0.7; } /* Always show on mobile */
    </style>
</head>
<body class="theme-matrix">

    <div class="scanlines"></div>
    <div id="toast-container"></div>

    <!-- START SCREEN -->
    <div id="start-overlay">
        <div id="start-content" class="flex flex-col items-center">
            <div class="text-5xl font-bold text-white mb-2 tracking-tighter">KAUÃ_OS</div>
            <div class="text-xs text-gray-500 tracking-[0.5em] mb-8">BOOTLOADER V26.0</div>
            
            <div class="text-sm text-gray-400 mb-4">SELECIONE O MODO:</div>
            <div class="flex">
                <div class="device-btn" onclick="OS.selectMode('desktop')">
                    <i data-lucide="monitor" class="w-8 h-8"></i>
                    <span>PC</span>
                </div>
                <div class="device-btn" onclick="OS.selectMode('mobile')">
                    <i data-lucide="smartphone" class="w-8 h-8"></i>
                    <span>MOBILE</span>
                </div>
            </div>
            <button id="install-btn" onclick="PWA.install()">
                <i data-lucide="download" class="w-4 h-4 mr-2"></i> INSTALAR APP
            </button>
        </div>
        <div id="boot-logs" style="display:none; font-family:'Fira Code'; width:300px; height:150px; overflow:hidden; flex-direction:column; justify-content:flex-end; margin-top:20px;"></div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="modal-settings" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">CONFIGURAÇÕES <span onclick="UI.closeModal('modal-settings')" class="cursor-pointer">X</span></div>
            <div class="modal-body">
                <button class="ui-btn" onclick="UI.setTheme('theme-matrix')">Matrix Green</button>
                <button class="ui-btn" onclick="UI.setTheme('theme-cyber')">Cyber Blue</button>
                <button class="ui-btn" onclick="UI.setTheme('theme-dracula')">Dracula</button>
                <button class="ui-btn" onclick="UI.setTheme('theme-fire')">Firewall Red</button>
                <div class="h-px bg-gray-800 my-2"></div>
                <button class="ui-btn" onclick="FS.exportZip()">
                    <i data-lucide="folder-down" class="w-4 text-yellow-400"></i> BAIXAR PROJETO (.ZIP)
                </button>
                <button class="ui-btn" onclick="PWA.install()">
                    <i data-lucide="download" class="w-4 text-blue-400"></i> INSTALAR APP
                </button>
                <button class="ui-btn" style="color:var(--danger)" onclick="FS.reset()">RESETAR TUDO</button>
            </div>
        </div>
    </div>

    <!-- NEW FILE MODAL -->
    <div id="modal-new" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">NOVO ARQUIVO <span onclick="UI.closeModal('modal-new')" class="cursor-pointer">X</span></div>
            <div class="modal-body">
                <input type="text" id="new-filename" class="ui-input" placeholder="Nome (ex: app.js)">
                <div class="grid grid-cols-2 gap-2 mt-2">
                    <button class="ui-btn" onclick="OS.createFile('html')">HTML</button>
                    <button class="ui-btn" onclick="OS.createFile('js')">JS</button>
                    <button class="ui-btn" onclick="OS.createFile('py')">PYTHON</button>
                    <button class="ui-btn" onclick="OS.createFile('txt')">TXT</button>
                </div>
            </div>
        </div>
    </div>

    <!-- IDE CANVAS -->
    <div id="immersive-canvas">
        <div class="canvas-header">
            <div class="flex items-center gap-2 flex-1 overflow-hidden">
                <div class="font-bold text-[var(--accent)] text-xs md:text-sm">IDE</div>
                <div class="tabs-container" id="tabs-bar"></div>
                <button class="btn" onclick="UI.openModal('modal-new')">+</button>
            </div>
            
            <div class="flex items-center gap-2">
                <button class="btn" onclick="FS.downloadCurrent()" title="Baixar Arquivo">
                    <i data-lucide="download" class="w-3 h-3"></i>
                </button>
                <div class="flex bg-[#111] rounded border border-[#333] p-0.5">
                    <button id="btn-view-preview" class="px-2 py-1 text-[10px] bg-[#333] text-white rounded-sm" onclick="Canvas.setView('preview')">VIEW</button>
                    <button id="btn-view-console" class="px-2 py-1 text-[10px] text-gray-500" onclick="Canvas.setView('console')">LOGS</button>
                </div>
                <button class="btn btn-ai hidden md:flex" onclick="AI.smartFormat()">
                    <i data-lucide="wand-2" class="w-3 h-3"></i>
                </button>
                <button class="btn" onclick="Canvas.run()" style="background:var(--accent); color:black;">
                    <i data-lucide="play" class="w-3 h-3"></i>
                </button>
                <button class="btn" onclick="Canvas.toggleFullscreen()">
                    <i data-lucide="maximize" class="w-3 h-3"></i>
                </button>
                <button class="btn" onclick="Canvas.close()">X</button>
            </div>
        </div>

        <div class="canvas-body">
            <div class="code-pane">
                <textarea id="editor-area" spellcheck="false" placeholder="// Escreva seu código..."></textarea>
            </div>
            <div class="preview-pane" id="preview-container">
                <button class="fs-exit-btn" onclick="Canvas.toggleFullscreen()">SAIR DA TELA CHEIA</button>
                <iframe id="web-preview"></iframe>
                <div id="console-view">
                    <div class="opacity-50 mb-2 border-b border-gray-700 pb-1">// TERMINAL OUTPUT</div>
                    <div id="console-logs"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN DESKTOP -->
    <div id="desktop-grid">
        <div class="panel power-off" id="p-header" style="grid-column: 1 / -1; grid-row: 1;">
            <div class="flex items-center justify-between h-full px-2 md:px-4">
                <div class="font-bold flex items-center gap-2 text-sm md:text-lg">
                    KAUÃ_OS <span class="text-[10px] border border-[var(--accent)] px-1 rounded text-[var(--accent)]">V26</span>
                </div>
                <div class="mobile-nav">
                    <div class="m-nav-btn active" onclick="OS.switchMobileTab('term')">TERM</div>
                    <div class="m-nav-btn" onclick="OS.switchMobileTab('files')">ARQ</div>
                    <div class="m-nav-btn" onclick="OS.switchMobileTab('sys')">SYS</div>
                    <div class="m-nav-btn" onclick="OS.switchMobileTab('net')">REDE</div>
                </div>
                <div class="flex gap-4 items-center">
                    <button onclick="UI.openModal('modal-settings')" class="text-[10px] hover:text-[var(--accent)] text-white">OPÇÕES</button>
                    <div id="clock" class="text-xs md:text-sm font-mono text-gray-500">00:00</div>
                </div>
            </div>
        </div>

        <div class="panel power-off" id="p-left" style="grid-column: 1; grid-row: 2 / 4;">
            <div class="panel-header">SISTEMA</div>
            <div class="p-4 flex flex-col gap-4 h-full">
                <div class="border border-[var(--border)] p-2 rounded bg-black">
                    <div class="flex justify-between text-xs mb-1"><span>CPU</span><span id="cpu-val">12%</span></div>
                    <div class="w-full bg-[#111] h-2 rounded overflow-hidden">
                        <div id="cpu-bar" class="h-full bg-[var(--accent)] w-12% transition-all"></div>
                    </div>
                </div>
                <div class="border border-[var(--border)] p-2 rounded bg-black">
                    <div class="flex justify-between text-xs mb-1"><span>RAM</span><span id="ram-val">4.2GB</span></div>
                    <div class="w-full bg-[#111] h-2 rounded overflow-hidden">
                        <div id="ram-bar" class="h-full bg-blue-500 w-60% animate-pulse"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="panel power-off active-panel" id="p-center" style="grid-column: 2; grid-row: 2;">
            <div class="panel-header">TERMINAL</div>
            <div id="term-out" class="font-mono text-xs p-2 text-gray-300 overflow-y-auto h-full"></div>
            <div class="bg-black p-2 flex items-center border-t border-[var(--border)]">
                <span style="color:var(--accent)" class="mr-2 font-bold">root@kaua:~$</span>
                <input id="cmd-input" type="text" class="bg-transparent border-none outline-none text-white flex-1 font-mono" autocomplete="off">
            </div>
        </div>

        <div class="panel power-off" id="p-right" style="grid-column: 3; grid-row: 2;">
            <div class="panel-header">REDE</div>
            <div class="flex-1 bg-black flex items-center justify-center relative overflow-hidden" id="net-container">
                <canvas id="globe-canvas"></canvas>
            </div>
        </div>

        <div class="panel power-off" id="p-files" style="grid-column: 2; grid-row: 3; width: 40%; float: left; margin-right: 5px;">
            <div class="panel-header">ARQUIVOS <span onclick="UI.openModal('modal-new')" class="cursor-pointer hover:text-white">+</span></div>
            <div id="file-grid" class="p-2 grid grid-cols-4 content-start overflow-y-auto h-full"></div>
        </div>

        <div class="panel power-off" id="p-keyboard" style="grid-column: 2 / 4; grid-row: 3; width: auto; margin-left: 41%;">
            <div class="panel-header">
                TECLADO 
                <i data-lucide="volume-2" id="kb-mute-btn" class="w-3 h-3 cursor-pointer hover:text-white" onclick="AudioSys.toggleMute()"></i>
            </div>
            <div id="kb-container" class="p-2 h-full flex flex-col justify-center gap-1"></div>
        </div>
    </div>

    <script>
        // --- PWA ---
        const PWA = {
            deferredPrompt: null,
            init() {
                window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); this.deferredPrompt = e; document.getElementById('install-btn').style.display='flex'; });
            },
            install() {
                if(this.deferredPrompt) {
                    this.deferredPrompt.prompt();
                    this.deferredPrompt.userChoice.then((choice) => { if(choice.outcome === 'accepted') { this.deferredPrompt = null; document.getElementById('install-btn').style.display='none'; } });
                } else alert("Para instalar: No Chrome, menu (3 pontos) -> 'Instalar aplicativo' ou 'Adicionar à tela inicial'.");
            }
        };
        PWA.init();

        // --- AUDIO (FIXED MOBILE) ---
        const AudioSys = {
            ctx: null, muted: false,
            init() { 
                window.AudioContext = window.AudioContext || window.webkitAudioContext; 
                this.ctx = new AudioContext(); 
                // Unlock audio on first touch
                const unlock = () => {
                    if(this.ctx.state === 'suspended') this.ctx.resume();
                    document.removeEventListener('touchstart', unlock);
                    document.removeEventListener('click', unlock);
                };
                document.addEventListener('touchstart', unlock);
                document.addEventListener('click', unlock);
            },
            toggleMute() { this.muted = !this.muted; document.getElementById('kb-mute-btn').classList.toggle('text-red-500', this.muted); },
            playStartup() {
                if(!this.ctx) this.init();
                const now = this.ctx.currentTime;
                [220,330,440,660].forEach((f,i)=>{
                    const o=this.ctx.createOscillator(); const g=this.ctx.createGain(); o.type='sawtooth'; o.frequency.value=f;
                    o.connect(g); g.connect(this.ctx.destination);
                    g.gain.setValueAtTime(0,now+i*0.1); g.gain.linearRampToValueAtTime(0.05,now+i*0.1+0.05); g.gain.exponentialRampToValueAtTime(0.001,now+i*0.1+0.3);
                    o.start(now+i*0.1); o.stop(now+i*0.1+0.4);
                });
            },
            play(type) {
                if(!this.ctx || this.muted) return;
                if(this.ctx.state === 'suspended') this.ctx.resume();
                const o=this.ctx.createOscillator(); const g=this.ctx.createGain(); o.connect(g); g.connect(this.ctx.destination);
                const t=this.ctx.currentTime; o.type='triangle'; o.frequency.setValueAtTime(type==='enter'?600:800,t);
                g.gain.exponentialRampToValueAtTime(0.001, t+0.05); o.start(t); o.stop(t+0.05);
            }
        };

        // --- FILES ---
        const FS = {
            files: {},
            init() { try{const s=localStorage.getItem('kaua_files'); this.files=s?JSON.parse(s):{'index.html':{type:'web',content:'<h1>Ola Mundo</h1>'}};}catch{this.files={};} },
            save() { localStorage.setItem('kaua_files',JSON.stringify(this.files)); UI.renderFiles(); },
            add(n,t,c) { this.files[n]={type:t,content:c}; this.save(); },
            delete(n) { delete this.files[n]; this.save(); Canvas.close(); }, // Delete logic
            reset() { localStorage.removeItem('kaua_files'); location.reload(); },
            downloadCurrent() {
                if(!Canvas.activeTab) return;
                const f = this.files[Canvas.activeTab];
                if(f) { const blob = new Blob([f.content], {type: 'text/plain'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = Canvas.activeTab; a.click(); }
            },
            exportZip() {
                const z = new JSZip();
                Object.keys(this.files).forEach(k => z.file(k, this.files[k].content));
                z.generateAsync({type:"blob"}).then(b => { const a = document.createElement('a'); a.href=URL.createObjectURL(b); a.download="projeto.zip"; a.click(); });
            }
        };

        // --- CANVAS ---
        const Canvas = {
            activeTab: null, openTabs: [],
            open(filename) {
                if(!this.openTabs.includes(filename)) this.openTabs.push(filename);
                this.activeTab = filename;
                document.getElementById('immersive-canvas').style.display='flex';
                this.renderTabs(); this.load(); this.setView('preview');
            },
            close() {
                document.getElementById('immersive-canvas').style.display='none';
                if(this.activeTab) { FS.files[this.activeTab].content = document.getElementById('editor-area').value; FS.save(); }
            },
            load() {
                const f = FS.files[this.activeTab];
                if(f) document.getElementById('editor-area').value = f.content;
                this.run();
            },
            run() {
                const code = document.getElementById('editor-area').value;
                const iframe = document.getElementById('web-preview');
                const consoleDiv = document.getElementById('console-logs');
                if(this.activeTab) { FS.files[this.activeTab].content = code; FS.save(); }
                consoleDiv.innerHTML = ''; iframe.src = 'about:blank';
                setTimeout(() => {
                    if(this.activeTab.endsWith('.html')) {
                        const doc = iframe.contentWindow.document; doc.open();
                        doc.write(`<script>
                            console.log = function(m){ window.parent.postMessage({type:'log', msg:m}, '*'); }
                            window.onerror = function(m){ window.parent.postMessage({type:'error', msg:m}, '*'); }
                        <`+`/script>${code}`);
                        doc.close();
                    } else {
                        this.setView('console');
                        try {
                            if(this.activeTab.endsWith('.js')) new Function('console', code)({ log: (m) => consoleDiv.innerHTML += `<div class="text-green-400">> ${m}</div>` });
                            else consoleDiv.innerHTML += `<div class="text-blue-400">> Simulação concluída.</div>`;
                        } catch(e) { consoleDiv.innerHTML += `<div class="text-red-500">${e.message}</div>`; }
                    }
                }, 50);
            },
            setView(mode) {
                const web = document.getElementById('web-preview');
                const cons = document.getElementById('console-view');
                const btnPrev = document.getElementById('btn-view-preview');
                const btnCons = document.getElementById('btn-view-console');
                if(mode === 'preview') { 
                    web.style.display='block'; cons.style.display='none'; 
                    btnPrev.classList.replace('text-gray-500','text-white'); btnPrev.classList.replace('bg-transparent','bg-[#333]');
                    btnCons.classList.replace('text-white','text-gray-500'); btnCons.classList.replace('bg-[#333]','bg-transparent');
                } else { 
                    web.style.display='none'; cons.style.display='block'; 
                    btnCons.classList.replace('text-gray-500','text-white'); btnCons.classList.replace('bg-transparent','bg-[#333]');
                    btnPrev.classList.replace('text-white','text-gray-500'); btnPrev.classList.replace('bg-[#333]','bg-transparent');
                }
            },
            renderTabs() {
                const c = document.getElementById('tabs-bar'); c.innerHTML='';
                this.openTabs.forEach(t => {
                    const el = document.createElement('div'); el.className = `tab ${t===this.activeTab?'active':''}`;
                    el.innerHTML = `${t} <span class="ml-2 hover:text-red-500" onclick="Canvas.closeTab('${t}', event)">x</span>`;
                    el.onclick = () => { this.activeTab = t; this.load(); this.renderTabs(); };
                    c.appendChild(el);
                });
            },
            closeTab(t, e) {
                e.stopPropagation();
                this.openTabs = this.openTabs.filter(x => x !== t);
                if(this.openTabs.length === 0) this.close();
                else if(this.activeTab === t) { this.activeTab = this.openTabs[0]; this.load(); }
                this.renderTabs();
            },
            toggleFullscreen() { document.getElementById('preview-container').classList.toggle('fullscreen'); }
        };

        const OS = {
            isMobile: false,
            selectMode(mode) {
                this.isMobile = (mode === 'mobile');
                if(this.isMobile) document.body.classList.add('mobile-mode');
                this.bootSequence();
            },
            bootSequence() {
                document.getElementById('start-content').style.display = 'none';
                document.getElementById('boot-logs').style.display = 'flex';
                AudioSys.playStartup();
                let steps = ["Kernel Init...", "Services...", "UI Load..."];
                let i=0;
                let int = setInterval(() => {
                    if(i >= steps.length) {
                        clearInterval(int);
                        document.getElementById('start-overlay').style.display='none';
                        document.getElementById('desktop-grid').style.opacity = 1;
                        if(this.isMobile) {
                            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active-panel'));
                            document.getElementById('p-center').classList.add('active-panel');
                        }
                        document.querySelectorAll('.power-off').forEach(e => {
                            if(!this.isMobile || e.classList.contains('active-panel') || e.id==='p-header' || e.id==='p-keyboard') {
                                e.classList.remove('power-off'); e.classList.add('power-on');
                            } else e.classList.remove('power-off');
                        });
                        return;
                    }
                    document.getElementById('boot-logs').innerHTML += `<div class="log-line">> ${steps[i]}</div>`;
                    i++;
                }, 400);
            },
            switchMobileTab(tab) {
                document.querySelectorAll('.panel').forEach(p => { if(p.id !== 'p-header' && p.id !== 'p-keyboard') p.classList.remove('active-panel'); });
                document.querySelectorAll('.m-nav-btn').forEach(b => b.classList.remove('active'));
                const map = { 'term': 'p-center', 'files': 'p-files', 'sys': 'p-left', 'net': 'p-right' };
                document.getElementById(map[tab]).classList.add('active-panel');
                const btnIndex = Object.keys(map).indexOf(tab);
                document.querySelectorAll('.m-nav-btn')[btnIndex].classList.add('active');
            },
            createFile(ext) {
                const n = document.getElementById('new-filename').value || 'untitled';
                FS.add(n+'.'+ext, 'code', ''); UI.closeModal('modal-new'); Canvas.open(n+'.'+ext);
            }
        };

        const AI = { smartFormat() { const e=document.getElementById('editor-area'); let c=e.value; if(Canvas.activeTab.endsWith('.html') && !c.includes('<!DOCTYPE')) c='<!DOCTYPE html>\n'+c; e.value=c; Canvas.run(); UI.toast('Formatado'); } };

        const UI = {
            init() { this.renderFiles(); this.renderKeys('kb-container'); this.startGlobe(); },
            renderFiles() {
                const g = document.getElementById('file-grid'); g.innerHTML='';
                Object.keys(FS.files).forEach(f => {
                    const d = document.createElement('div');
                    d.className="relative file-item flex flex-col items-center cursor-pointer hover:bg-white/10 p-2 rounded text-[10px] text-gray-400 group";
                    d.innerHTML=`
                        <i data-lucide="file-code" class="w-5 h-5 mb-1"></i>
                        <span class="truncate w-full text-center">${f}</span>
                        <div class="file-del-btn" onclick="event.stopPropagation(); FS.delete('${f}')"><i data-lucide="x-circle" class="w-4 h-4 bg-black rounded-full"></i></div>
                    `;
                    d.onclick = () => Canvas.open(f); g.appendChild(d);
                });
                lucide.createIcons();
            },
            renderKeys(cid) {
                const c = document.getElementById(cid); c.innerHTML = '';
                ["1234567890","QWERTYUIOP","ASDFGHJKL","ZXCVBNM"].forEach(r => {
                    const d = document.createElement('div'); d.className="flex gap-1 justify-center w-full mb-1";
                    r.split('').forEach(ch => {
                        const k = document.createElement('div'); k.className="key flex-1 h-8"; k.innerText=ch; k.dataset.key=ch;
                        const trig = (e) => { 
                            if(e.type==='touchstart') e.preventDefault(); 
                            const a = document.activeElement.tagName==='TEXTAREA'?document.activeElement:document.getElementById('cmd-input'); 
                            a.value+=ch; 
                            AudioSys.play('type'); 
                            k.classList.add('active'); 
                            setTimeout(()=>k.classList.remove('active'), 100); 
                        };
                        k.addEventListener('mousedown', trig); k.addEventListener('touchstart', trig);
                        d.appendChild(k);
                    });
                    c.appendChild(d);
                });
                const sp = document.createElement('div'); sp.className="flex justify-center";
                const k = document.createElement('div'); k.className="key w-1/2 h-8"; k.innerText="SPACE";
                const trigSp = (e) => { if(e.type==='touchstart') e.preventDefault(); document.getElementById('cmd-input').value+=' '; AudioSys.play('type'); k.classList.add('active'); setTimeout(()=>k.classList.remove('active'), 100); };
                k.addEventListener('mousedown', trigSp); k.addEventListener('touchstart', trigSp);
                sp.appendChild(k); c.appendChild(sp);
            },
            openModal(id) { document.getElementById(id).style.display='flex'; },
            closeModal(id) { document.getElementById(id).style.display='none'; },
            setTheme(t) { document.body.className = t; if(OS.isMobile) document.body.classList.add('mobile-mode'); localStorage.setItem('kaua_theme', t); this.closeModal('modal-settings'); },
            startGlobe() {
                const c = document.getElementById('globe-canvas'); const ctx = c.getContext('2d');
                let t=0;
                function loop() {
                    if(!c.offsetParent) return requestAnimationFrame(loop);
                    c.width = c.parentElement.offsetWidth; c.height = c.parentElement.offsetHeight;
                    ctx.fillStyle='black'; ctx.fillRect(0,0,c.width,c.height);
                    t+=0.02; ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--accent');
                    for(let i=0;i<60;i++) {
                        const a = (i/60)*6.28+t; const x = Math.cos(a)*40 + c.width/2; const y = Math.sin(a)*10 + c.height/2;
                        ctx.beginPath(); ctx.arc(x,y,2,0,6.28); ctx.fill();
                    }
                    requestAnimationFrame(loop);
                }
                loop();
            },
            toast(m) {
                const c = document.getElementById('toast-container');
                const d = document.createElement('div'); d.className='toast';
                d.innerHTML = `<i data-lucide="info" class="w-4 h-4"></i> ${m}`;
                c.appendChild(d); lucide.createIcons(); setTimeout(()=>d.remove(),3000);
            }
        };

        window.addEventListener('message', e => { if(e.data.type==='log') document.getElementById('console-logs').innerHTML+=`<div>> ${e.data.msg}</div>`; });
        window.addEventListener('keydown', e => {
            const k = document.querySelector(`.key[data-key="${e.key.toUpperCase()}"]`);
            if(k) { k.classList.add('active'); setTimeout(()=>k.classList.remove('active'),150); AudioSys.play('type'); }
            if(e.key==='Enter' && document.activeElement.id==='cmd-input') {
                const v = document.getElementById('cmd-input').value;
                document.getElementById('term-out').innerHTML+=`<div>root:~$ ${v}</div>`;
                if(v.startsWith('code')) Canvas.open(v.split(' ')[1]);
                document.getElementById('cmd-input').value=''; AudioSys.play('type');
            }
        });

        setInterval(() => {
            document.getElementById('clock').innerText = new Date().toLocaleTimeString();
            document.getElementById('cpu-val').innerText = Math.floor(Math.random()*30+10)+"%";
            document.getElementById('cpu-bar').style.width = document.getElementById('cpu-val').innerText;
        }, 1000);

        FS.init(); UI.init();
    </script>
</body>
</html>
