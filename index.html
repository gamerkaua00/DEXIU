<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KAUÃ_OS // V14_ULTIMATE</title>
    
    <!-- Bibliotecas Externas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">

    <style>
        /* --- TEMAS (CSS Variables) --- */
        :root {
            --bg: #050505;
            --panel: #0a0a0a;
            --border: #333;
            --accent: #00ff41;
            --text: #e0e0e0;
            --danger: #ef4444;
            --warning: #f59e0b;
            --ai-color: #8b5cf6;
        }

        /* Classes de Tema */
        body.theme-matrix { --bg: #000; --panel: #020a02; --border: #003300; --accent: #00ff41; }
        body.theme-cyber { --bg: #050510; --panel: #0a0a1a; --border: #003366; --accent: #00f3ff; }
        body.theme-dracula { --bg: #282a36; --panel: #44475a; --border: #6272a4; --accent: #ff79c6; }
        body.theme-fire { --bg: #1a0500; --panel: #2a0a00; --border: #661a00; --accent: #ff4500; }

        * { box-sizing: border-box; user-select: none; }
        
        body {
            background-color: var(--bg); color: var(--text);
            font-family: 'Share Tech Mono', monospace;
            height: 100vh; width: 100vw; overflow: hidden;
            margin: 0; display: flex; justify-content: center; align-items: center;
            transition: background 0.5s, color 0.5s;
        }

        /* --- FX --- */
        .scanlines {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), 
                        linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%; pointer-events: none; z-index: 10; opacity: 0.15;
        }

        /* --- ANIMATIONS (Power On Effect) --- */
        .power-off { opacity: 0; filter: brightness(0) blur(2px); pointer-events: none; }
        
        .power-on { 
            opacity: 1; filter: brightness(1) blur(0); pointer-events: all;
            animation: powerOnFlicker 0.6s ease-out forwards;
            box-shadow: 0 0 15px rgba(0,0,0,0.3);
        }

        @keyframes powerOnFlicker {
            0% { opacity: 0; } 10% { opacity: 0.4; } 20% { opacity: 0.1; }
            40% { opacity: 0.8; } 60% { opacity: 0.2; } 70% { opacity: 0.9; }
            80% { opacity: 0.5; } 100% { opacity: 1; }
        }

        /* --- NOTIFICATION TOAST --- */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 500; display: flex; flex-direction: column; gap: 10px; }
        .toast {
            background: #111; border: 1px solid var(--accent); color: white; padding: 10px 20px;
            font-size: 12px; border-radius: 4px; box-shadow: 0 0 15px rgba(0,0,0,0.5);
            animation: slideIn 0.3s ease-out; display: flex; align-items: center; gap: 10px;
        }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* --- MODALS --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 200;
            display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px);
        }
        .modal-box {
            background: var(--panel); border: 1px solid var(--accent); padding: 2px;
            width: 320px; box-shadow: 0 0 30px var(--accent);
            display: flex; flex-direction: column; animation: modalPop 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes modalPop { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .modal-header {
            background: var(--accent); color: black; font-weight: bold; padding: 6px 12px;
            text-transform: uppercase; font-size: 12px; display: flex; justify-content: space-between;
        }
        .modal-body { padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        
        .ui-btn {
            background: #111; border: 1px solid #333; color: #ccc; padding: 8px;
            cursor: pointer; text-align: left; transition: 0.2s; font-size: 12px;
            display: flex; align-items: center; gap: 8px;
        }
        .ui-btn:hover { background: #222; border-color: var(--accent); color: white; padding-left: 12px; }
        .ui-input {
            background: #050505; border: 1px solid #333; color: white; padding: 8px;
            font-family: 'Share Tech Mono'; outline: none; width: 100%;
        }
        .ui-input:focus { border-color: var(--accent); }

        /* --- IMMERSIVE CANVAS --- */
        #immersive-canvas {
            position: fixed; inset: 0; z-index: 100;
            background: var(--bg);
            display: none; flex-direction: column;
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .canvas-header {
            height: 50px; border-bottom: 1px solid var(--border); background: var(--panel);
            display: flex; align-items: center; justify-content: space-between; padding: 0 15px;
        }

        /* TABS */
        .tabs-container { display: flex; gap: 2px; overflow-x: auto; max-width: 40vw; }
        .tab {
            padding: 4px 12px; background: #111; border: 1px solid #333; border-bottom: none;
            color: #666; font-size: 11px; cursor: pointer; display: flex; align-items: center; gap: 6px;
            border-radius: 4px 4px 0 0; margin-top: 6px; position: relative;
        }
        .tab.active { background: var(--bg); border-color: var(--accent); color: white; height: 32px; border-bottom: 2px solid var(--bg); z-index: 10;}
        .tab-close { font-size: 14px; opacity: 0.5; } .tab-close:hover { opacity: 1; color: var(--danger); }

        .canvas-body { flex: 1; display: flex; overflow: hidden; position: relative; }

        .code-pane {
            flex: 1; display: flex; flex-direction: column; border-right: 1px solid var(--border);
            background: #080808; min-width: 300px;
        }
        .preview-pane {
            flex: 1; display: flex; flex-direction: column;
            background: #ffffff; position: relative; transition: all 0.3s ease;
        }
        
        /* FULLSCREEN PREVIEW */
        .preview-pane.fullscreen {
            position: fixed; inset: 0; z-index: 200; width: 100% !important; height: 100% !important;
        }
        .fullscreen-exit-btn {
            display: none; position: absolute; top: 10px; right: 10px; z-index: 210;
            background: red; color: white; border: none; padding: 5px 10px; cursor: pointer; font-weight: bold; border-radius: 4px;
        }
        .preview-pane.fullscreen .fullscreen-exit-btn { display: block; }

        /* Error Overlay */
        #error-overlay {
            position: absolute; bottom: 0; left: 0; width: 100%; max-height: 40%;
            background: rgba(20,0,0,0.95); border-top: 2px solid var(--danger);
            color: white; padding: 10px; overflow-y: auto; font-family: monospace; font-size: 12px;
            display: none; z-index: 20;
        }
        .error-title { color: var(--danger); font-weight: bold; margin-bottom: 5px; display: flex; align-items: center; gap: 5px; }

        #editor-area {
            flex: 1; background: transparent; color: #d4d4d4; border: none; outline: none;
            padding: 20px; font-family: 'Fira Code', monospace; font-size: 13px; resize: none;
            line-height: 1.5; white-space: pre;
        }

        /* --- DESKTOP GRID --- */
        #desktop-grid {
            display: grid; width: 100%; height: 100%; padding: 6px; gap: 6px;
            grid-template-columns: 260px 1fr 260px; 
            grid-template-rows: 50px 1fr 240px;
            opacity: 1;
        }

        @media (max-width: 1024px) {
            #desktop-grid { grid-template-columns: 1fr; grid-template-rows: 40px 1fr 200px; }
            #p-left, #p-right, #p-files { display: none !important; }
            #p-header { grid-column: 1 !important; grid-row: 1 !important; }
            #p-center { grid-column: 1 !important; grid-row: 2 !important; }
            #p-keyboard { grid-column: 1 !important; grid-row: 3 !important; width: 100% !important; margin-left: 0 !important; }
            .canvas-body { flex-direction: column; }
            .code-pane { border-right: none; border-bottom: 1px solid var(--border); height: 50%; }
        }

        .panel { background: var(--panel); border: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .panel-header { background: #000; padding: 6px 10px; font-size: 11px; text-transform: uppercase; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; color: #666; }

        /* --- UI HELPERS --- */
        .btn {
            background: #111; border: 1px solid #333; color: #ccc;
            padding: 5px 12px; font-size: 11px; cursor: pointer; transition: 0.2s;
            display: flex; items-center; gap: 5px; border-radius: 3px;
        }
        .btn:hover { border-color: var(--accent); color: white; }
        .btn-primary { background: var(--accent); color: black; font-weight: bold; border: none; }
        .btn-primary:hover { opacity: 0.8; }
        
        .btn-ai { border-color: var(--ai-color); color: var(--ai-color); }
        .btn-ai:hover { background: var(--ai-color); color: white; box-shadow: 0 0 10px var(--ai-color); }

        .btn-share { border-color: #3b82f6; color: #3b82f6; }
        .btn-share:hover { background: #3b82f6; color: white; }

        #term-out { flex: 1; padding: 10px; overflow-y: auto; color: #ccc; font-size: 13px; }
        .cmd-line { color: white; font-weight: bold; margin-top: 5px; }
        .key { background: #111; border: 1px solid #333; border-radius: 4px; display:flex; justify-content:center; align-items:center; cursor:pointer; font-size:12px; color:#666; transition: 0.05s; }
        .key.active { background: var(--accent); color: black; box-shadow: 0 0 10px var(--accent); transform: translateY(1px); }

        /* START OVERLAY */
        #start-overlay {
            position: fixed; inset: 0; background: #000; z-index: 300;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .loader-bar { width: 200px; height: 2px; background: #222; margin-top: 20px; overflow: hidden; }
        .loader-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.1s; }

    </style>
</head>
<body class="theme-matrix">

    <div class="scanlines"></div>
    <div id="toast-container"></div>

    <!-- START SCREEN -->
    <div id="start-overlay" onclick="OS.boot()">
        <div class="text-4xl font-bold text-white mb-2 tracking-tighter">KAUÃ_OS <span class="text-xs bg-white text-black px-1 rounded">V14</span></div>
        <div class="text-xs text-gray-500 blink-text">CLIQUE PARA INICIAR SISTEMA</div>
        <div class="loader-bar"><div class="loader-fill" id="boot-fill"></div></div>
    </div>

    <!-- NEW FILE MODAL -->
    <div id="modal-new" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">NOVO ARQUIVO <span onclick="UI.closeModal('modal-new')" class="cursor-pointer">X</span></div>
            <div class="modal-body">
                <input type="text" id="new-filename" class="ui-input" placeholder="Nome (ex: app.js)">
                <div class="text-xs text-gray-500 mt-2">MODELOS:</div>
                <button class="ui-btn" onclick="OS.createFile('html')"><i data-lucide="globe" class="w-4 text-blue-400"></i> HTML5 (Web)</button>
                <button class="ui-btn" onclick="OS.createFile('js')"><i data-lucide="file-json" class="w-4 text-yellow-400"></i> JAVASCRIPT</button>
                <button class="ui-btn" onclick="OS.createFile('py')"><i data-lucide="terminal" class="w-4 text-green-400"></i> PYTHON</button>
                <button class="ui-btn" onclick="OS.createFile('txt')"><i data-lucide="file-text" class="w-4 text-gray-400"></i> NOTAS (TXT)</button>
            </div>
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="modal-settings" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">CONFIGURAÇÕES <span onclick="UI.closeModal('modal-settings')" class="cursor-pointer">X</span></div>
            <div class="modal-body">
                <div class="text-xs text-gray-500">TEMAS VISUAIS:</div>
                <button class="ui-btn" onclick="UI.setTheme('theme-matrix')"><div class="w-3 h-3 bg-green-500 rounded-full"></div> Matrix Green (Padrão)</button>
                <button class="ui-btn" onclick="UI.setTheme('theme-cyber')"><div class="w-3 h-3 bg-cyan-500 rounded-full"></div> Cyber Blue</button>
                <button class="ui-btn" onclick="UI.setTheme('theme-dracula')"><div class="w-3 h-3 bg-purple-500 rounded-full"></div> Dracula Purple</button>
                <button class="ui-btn" onclick="UI.setTheme('theme-fire')"><div class="w-3 h-3 bg-red-500 rounded-full"></div> Firewall Red</button>
                <div class="h-px bg-gray-800 my-2"></div>
                <button class="ui-btn" onclick="FS.exportZip()"><i data-lucide="download" class="w-4"></i> BAIXAR PROJETO (.ZIP)</button>
                <button class="ui-btn" style="color:var(--danger)" onclick="FS.reset()"><i data-lucide="trash" class="w-4"></i> RESETAR FABRICA</button>
            </div>
        </div>
    </div>

    <!-- IMMERSIVE CANVAS -->
    <div id="immersive-canvas">
        <div class="canvas-header">
            <div class="flex items-center gap-4" style="flex: 1; overflow: hidden;">
                <div class="font-bold text-sm tracking-widest text-[var(--accent)]">IDE</div>
                <!-- TABS -->
                <div class="tabs-container" id="tabs-bar">
                    <!-- Tabs Injected Here -->
                </div>
                <button class="btn" onclick="UI.openModal('modal-new')">+</button>
            </div>
            
            <div class="flex items-center gap-2">
                <button class="btn btn-ai" onclick="AI.fixCode()">
                    <i data-lucide="sparkles" class="w-3 h-3"></i> <span class="hidden md:inline">CORRIGIR (AI)</span>
                </button>
                <button class="btn btn-share" onclick="FS.shareLink()">
                    <i data-lucide="share-2" class="w-3 h-3"></i>
                </button>
                <div class="w-px h-4 bg-gray-700 mx-1"></div>
                <button class="btn btn-primary" onclick="Canvas.run()">
                    <i data-lucide="play" class="w-3 h-3"></i> <span class="hidden md:inline">RODAR</span>
                </button>
                <button class="btn" onclick="Canvas.toggleFullscreenPreview()" title="Expandir Preview">
                    <i data-lucide="maximize" class="w-3 h-3"></i>
                </button>
                <button class="btn" onclick="Canvas.close()">X</button>
            </div>
        </div>

        <div class="canvas-body">
            <div class="code-pane">
                <textarea id="editor-area" spellcheck="false" placeholder="// Escreva seu código aqui..."></textarea>
            </div>
            <div class="preview-pane" id="preview-container">
                <button class="fullscreen-exit-btn" onclick="Canvas.toggleFullscreenPreview()">SAIR DA TELA CHEIA</button>
                <iframe id="web-preview" class="w-full h-full border-none bg-white"></iframe>
                <div id="console-preview" class="w-full h-full p-4 font-mono text-sm overflow-auto text-[var(--accent)] hidden bg-[#050505]"></div>
                
                <!-- Error Overlay -->
                <div id="error-overlay">
                    <div class="error-title"><i data-lucide="alert-triangle" class="w-4 h-4"></i> ERRO DETECTADO:</div>
                    <div id="error-msg" class="text-gray-300 mb-2"></div>
                    <button class="btn btn-ai w-full justify-center" onclick="AI.fixCode()">TENTAR CORREÇÃO AUTOMÁTICA</button>
                </div>
            </div>
        </div>
    </div>

    <!-- DESKTOP GRID -->
    <div id="desktop-grid">
        <!-- HEADER -->
        <div class="panel power-off" id="p-header" style="grid-column: 1 / -1; grid-row: 1;">
            <div class="flex items-center justify-between h-full px-4">
                <div class="font-bold text-lg flex gap-2 items-center">
                    KAUÃ_OS <span class="text-[10px] border border-[var(--accent)] px-1 rounded text-[var(--accent)]">V14</span>
                </div>
                <div class="flex gap-4 items-center">
                    <button onclick="UI.openModal('modal-settings')" class="text-[10px] hover:text-[var(--accent)] transition">OPÇÕES</button>
                    <div id="clock" class="text-sm font-mono text-gray-500">00:00</div>
                </div>
            </div>
        </div>

        <!-- LEFT -->
        <div class="panel power-off" id="p-left" style="grid-column: 1; grid-row: 2 / 4;">
            <div class="panel-header">SISTEMA</div>
            <div class="p-4 flex flex-col gap-4">
                <canvas id="cpu-chart" class="w-full h-24 border border-[var(--border)] bg-black"></canvas>
                <div class="text-xs text-gray-400">CPU: <span id="cpu-val" style="color:var(--accent)">12%</span></div>
                <div class="mt-auto border-t border-[var(--border)] pt-2">
                    <div class="text-[10px] text-gray-500">CACHE: <span class="text-green-500">ATIVO</span></div>
                    <div class="text-[10px] text-gray-500">AI ENGINE: <span class="text-purple-500">READY</span></div>
                </div>
            </div>
        </div>

        <!-- CENTER (TERMINAL) -->
        <div class="panel power-off" id="p-center" style="grid-column: 2; grid-row: 2;">
            <div class="panel-header">TERMINAL</div>
            <div id="term-out"></div>
            <div class="bg-black p-2 flex items-center border-t border-[var(--border)]">
                <span style="color:var(--accent)" class="mr-2 font-bold">root@kaua:~$</span>
                <input id="cmd-input" type="text" class="bg-transparent border-none outline-none text-white flex-1 font-mono" autocomplete="off">
            </div>
        </div>

        <!-- RIGHT (GLOBE) -->
        <div class="panel power-off" id="p-right" style="grid-column: 3; grid-row: 2;">
            <div class="panel-header">REDE</div>
            <div class="flex-1 bg-black flex items-center justify-center relative">
                <canvas id="globe-canvas"></canvas>
            </div>
        </div>

        <!-- FILES -->
        <div class="panel power-off" id="p-files" style="grid-column: 2; grid-row: 3; width: 40%; float: left; margin-right: 5px;">
            <div class="panel-header">
                <span>ARQUIVOS</span>
                <button onclick="UI.openModal('modal-new')" class="text-[9px] hover:text-[var(--accent)] cursor-pointer">[+] NOVO</button>
            </div>
            <div id="file-grid" class="p-2 grid grid-cols-4 gap-2 content-start overflow-y-auto h-full"></div>
        </div>

        <!-- KEYBOARD -->
        <div class="panel power-off" id="p-keyboard" style="grid-column: 2 / 4; grid-row: 3; width: auto; margin-left: 41%;">
            <div class="panel-header">INPUT</div>
            <div id="kb-container" class="p-2 h-full flex flex-col justify-center gap-1"></div>
        </div>
    </div>

    <script>
        // --- CORE AUDIO ---
        const AudioSys = {
            ctx: null,
            init() {
                window.AudioContext = window.AudioContext || window.webkitAudioContext;
                this.ctx = new AudioContext();
            },
            play(type) {
                if (!this.ctx) this.init();
                if (this.ctx.state === 'suspended') this.ctx.resume();
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.connect(gain); gain.connect(this.ctx.destination);
                const now = this.ctx.currentTime;
                
                if (type === 'type') {
                    osc.type = 'triangle'; osc.frequency.setValueAtTime(800, now);
                    gain.gain.setValueAtTime(0.05, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.05);
                    osc.start(now); osc.stop(now + 0.05);
                } else if (type === 'boot') {
                    osc.type = 'sawtooth'; osc.frequency.setValueAtTime(100, now);
                    osc.frequency.linearRampToValueAtTime(600, now + 0.3);
                    gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.5);
                    osc.start(now); osc.stop(now + 0.5);
                } else if (type === 'error') {
                    osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now);
                    osc.frequency.linearRampToValueAtTime(100, now + 0.2);
                    gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.2);
                    osc.start(now); osc.stop(now + 0.2);
                }
            }
        };

        // --- AI ENGINE V2 (Relaxed & Helpful) ---
        const AI = {
            fixCode() {
                const editor = document.getElementById('editor-area');
                let code = editor.value;
                let original = code;
                let fixes = [];

                // 1. HTML Stack Checker
                if (Canvas.activeTab.endsWith('.html')) {
                    const matches = code.matchAll(/<\/?([a-z]+)[^>]*>/gi);
                    const tags = [];
                    for (const m of matches) {
                        if(m[0].startsWith('</')) {
                            if(tags.length > 0) tags.pop();
                        } else if(!m[0].endsWith('/>') && !['<br>', '<hr>', '<img>', '<input>', '<meta>', '<link>', '<!doctype>'].includes(m[0].toLowerCase())) {
                            tags.push(m[1]);
                        }
                    }
                    if (tags.length > 0) {
                        while(tags.length > 0) {
                            const t = tags.pop();
                            code += `\n</${t}>`;
                            fixes.push(`Fechada tag <${t}>`);
                        }
                    }
                    if (code.includes('<script') && !code.includes('<' + '/script>')) {
                        code += '\n<' + '/script>';
                        fixes.push("Script fechado");
                    }
                }
                
                // 2. JS Checker (Safe)
                if (Canvas.activeTab.endsWith('.js')) {
                    if (code.includes('console.print')) {
                        code = code.replace(/console\.print/g, 'console.log');
                        fixes.push("console.print -> console.log");
                    }
                }

                // 3. Python Fixer
                if (Canvas.activeTab.endsWith('.py')) {
                    if (code.match(/print\s+".*"/)) {
                        code = code.replace(/print\s+"(.*)"/g, 'print("$1")');
                        fixes.push("Sintaxe print Python 3");
                    }
                }

                if (code !== original) {
                    editor.value = code;
                    Canvas.run();
                    UI.toast("AI: " + fixes.join(", "), "success");
                } else {
                    UI.toast("AI: Nenhum erro óbvio encontrado.", "info");
                }
            }
        };

        // --- FILE SYSTEM ---
        const FS = {
            files: {},
            init() {
                try {
                    const saved = localStorage.getItem('kaua_os_files');
                    if(saved) this.files = JSON.parse(saved);
                    else this.reset();
                } catch(e) { this.reset(); }
            },
            save() {
                localStorage.setItem('kaua_os_files', JSON.stringify(this.files));
                UI.renderFiles();
            },
            reset() {
                this.files = {
                    'index.html': { type: 'web', content: '<!-- WebContainer Simulado -->\n<h1>Olá Mundo!</h1>\n<script>\n  console.log("Sistema pronto.");\n<' + '/script>' },
                    'notes.txt': { type: 'text', content: 'Tarefas:\n1. Criar site.\n2. Validar código.' }
                };
                this.save();
            },
            addFile(name, type, content) {
                this.files[name] = { type, content };
                this.save();
            },
            exportZip() {
                const zip = new JSZip();
                Object.keys(this.files).forEach(name => zip.file(name, this.files[name].content));
                zip.generateAsync({type:"blob"}).then(function(content) {
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(content);
                    link.download = "projeto_kaua_os.zip";
                    link.click();
                });
                UI.toast("Download do ZIP iniciado.", "success");
            },
            shareLink() {
                const url = "https://kaua-os.dev/share/" + Math.random().toString(36).substring(7);
                navigator.clipboard.writeText(url).then(() => {
                    UI.toast("Link copiado!", "success");
                }).catch(() => {
                    UI.toast("Link: " + url, "info");
                });
            }
        };

        // --- CANVAS (IDE) ---
        const Canvas = {
            el: document.getElementById('immersive-canvas'),
            editor: document.getElementById('editor-area'),
            webFrame: document.getElementById('web-preview'),
            consoleFrame: document.getElementById('console-preview'),
            previewContainer: document.getElementById('preview-container'),
            errorOverlay: document.getElementById('error-overlay'),
            
            openTabs: [],
            activeTab: null,

            open(filename) {
                if(!this.openTabs.includes(filename)) this.openTabs.push(filename);
                this.activeTab = filename;
                
                this.el.style.display = 'flex';
                document.getElementById('desktop-grid').style.filter = 'blur(10px)';
                
                this.renderTabs();
                this.loadContent();
            },
            
            closeTab(filename, e) {
                e.stopPropagation();
                this.openTabs = this.openTabs.filter(t => t !== filename);
                if(this.openTabs.length === 0) this.close();
                else if(this.activeTab === filename) this.open(this.openTabs[this.openTabs.length-1]);
                else this.renderTabs();
            },

            renderTabs() {
                const bar = document.getElementById('tabs-bar');
                bar.innerHTML = '';
                this.openTabs.forEach(f => {
                    const tab = document.createElement('div');
                    tab.className = `tab ${f === this.activeTab ? 'active' : ''}`;
                    tab.innerHTML = `<span>${f}</span> <span class="tab-close" onclick="Canvas.closeTab('${f}', event)">x</span>`;
                    tab.onclick = () => this.open(f);
                    bar.appendChild(tab);
                });
            },

            loadContent() {
                const file = FS.files[this.activeTab];
                if(file) this.editor.value = file.content;
                this.errorOverlay.style.display = 'none'; // Clear error on load
                
                if(file.type === 'web' || this.activeTab.endsWith('.html')) {
                    this.webFrame.style.display = 'block';
                    this.consoleFrame.style.display = 'none';
                    this.runWeb(); 
                } else {
                    this.webFrame.style.display = 'none';
                    this.consoleFrame.style.display = 'block';
                    this.consoleFrame.innerHTML = "<div class='opacity-50'>// Aguardando execução...</div>";
                }
            },

            close() {
                this.el.style.display = 'none';
                document.getElementById('desktop-grid').style.filter = 'none';
                if(this.activeTab) FS.files[this.activeTab].content = this.editor.value;
                FS.save();
            },

            // SAFE EXECUTION ENGINE
            run() {
                const code = this.editor.value;
                FS.files[this.activeTab].content = code;
                FS.save();
                
                // IMPORTANT: Reset State
                this.errorOverlay.style.display = 'none';
                this.consoleFrame.innerHTML = '';

                if(this.activeTab.endsWith('.html')) this.runWeb();
                else if(this.activeTab.endsWith('.js')) this.runJS(code);
                else this.runSimulated(code);
            },

            runWeb() {
                const code = this.editor.value;
                const frameDoc = this.webFrame.contentWindow.document;
                frameDoc.open();
                // Inject Error Catcher in Iframe safely
                const safeScript = `<script>window.onerror = function(msg, url, line) { window.parent.postMessage({type:'error', msg: msg + ' (Linha ' + line + ')'}, '*'); }<` + `/script>`;
                frameDoc.write(safeScript + code);
                frameDoc.close();
            },

            runJS(code) {
                this.consoleFrame.innerHTML = "";
                const safeCode = this.injectLoopGuard(code);
                try {
                    const log = (msg) => this.consoleFrame.innerHTML += `<div class="text-green-400">> ${msg}</div>`;
                    const console = { log: log, error: (m)=>this.showError(m) };
                    // Wrap inside anonymous function to avoid global scope pollution
                    new Function('console', safeCode)(console);
                } catch(e) {
                    this.showError(e.message);
                }
            },

            runSimulated(code) {
                this.consoleFrame.innerHTML = "";
                const lines = code.split('\n');
                let foundOutput = false;
                lines.forEach((line, i) => {
                    let out = null;
                    if(line.match(/print\((.*)\)/)) out = line.match(/print\((.*)\)/)[1];
                    else if(line.match(/System.out.println\((.*)\)/)) out = line.match(/System.out.println\((.*)\)/)[1];
                    
                    if(out) {
                        foundOutput = true;
                        setTimeout(() => {
                            this.consoleFrame.innerHTML += `<div class="text-blue-400 border-l border-blue-800 pl-2 mb-1">> ${out.replace(/["']/g, '')}</div>`;
                        }, i * 100);
                    }
                });
                if(!foundOutput) this.consoleFrame.innerHTML = "<div class='text-yellow-500'>Compilação concluída (Sem saída).</div>";
            },

            injectLoopGuard(code) {
                return `let _loopLimit = 1000; ${code.replace(/while\s*\((.*?)\)/g, 'while($1 && _loopLimit-- > 0)').replace(/for\s*\((.*?)\)/g, 'for($1) if(_loopLimit-- <= 0) break;')}`;
            },

            showError(msg) {
                this.errorOverlay.style.display = 'block';
                document.getElementById('error-msg').innerText = msg;
                AudioSys.play('error');
            },

            toggleFullscreenPreview() {
                this.previewContainer.classList.toggle('fullscreen');
            }
        };

        window.addEventListener('message', (e) => {
            if(e.data.type === 'error') Canvas.showError(e.data.msg);
        });

        // --- OS BOOT & UI ---
        const OS = {
            boot() {
                const ol = document.getElementById('start-overlay');
                const fill = document.getElementById('boot-fill');
                
                AudioSys.init(); AudioSys.play('boot');
                fill.style.width = "100%";
                
                setTimeout(() => {
                    ol.style.opacity = '0';
                    setTimeout(() => ol.style.display = 'none', 500);
                    this.startHouseLights();
                }, 1000);
            },

            startHouseLights() {
                const panels = ['p-header', 'p-left', 'p-center', 'p-right', 'p-files', 'p-keyboard'];
                // Staggered boot
                panels.forEach((id, idx) => {
                    setTimeout(() => {
                        const el = document.getElementById(id);
                        el.classList.remove('power-off');
                        el.classList.add('power-on');
                        AudioSys.play('type');
                    }, idx * 300); // Slower, more cinematic
                });
                
                setTimeout(() => {
                    FS.init();
                    UI.init();
                    Term.print("KAUÃ_OS V14 ONLINE.", "text-green-500");
                }, 2000);
            },

            createFile(ext) {
                const name = document.getElementById('new-filename').value || 'untitled';
                let content = "", type = "code";
                
                if(ext === 'html') { content = "<h1>Ola</h1>"; type = "web"; }
                else if(ext === 'js') { content = "console.log('JS Rodando');"; type = "code"; }
                else if(ext === 'py') { content = "print('Python Simulado')"; type = "code"; }
                
                FS.addFile(name + '.' + ext, type, content);
                UI.closeModal('modal-new');
                Canvas.open(name + '.' + ext);
            }
        };

        const UI = {
            init() {
                this.renderFiles();
                this.renderKeys();
                this.startGlobe();
                const t = localStorage.getItem('kaua_theme');
                if(t) document.body.className = t;
            },
            
            renderFiles() {
                const g = document.getElementById('file-grid');
                g.innerHTML = '';
                Object.keys(FS.files).forEach(f => {
                    const d = document.createElement('div');
                    d.className = "flex flex-col items-center cursor-pointer hover:bg-white/10 p-2 rounded text-[10px] text-gray-400";
                    let icon = f.endsWith('.html') ? 'globe' : (f.endsWith('.txt') ? 'file-text' : 'code');
                    d.innerHTML = `<i data-lucide="${icon}" class="w-5 h-5 mb-1"></i>${f}`;
                    d.onclick = () => Canvas.open(f);
                    g.appendChild(d);
                });
                lucide.createIcons();
            },
            
            renderKeys() {
                const k = document.getElementById('kb-container');
                k.innerHTML = '';
                ["1234567890", "QWERTYUIOP", "ASDFGHJKL", "ZXCVBNM"].forEach(row => {
                    const r = document.createElement('div');
                    r.className = "flex gap-1 justify-center w-full mb-1";
                    row.split('').forEach(char => {
                        const key = document.createElement('div');
                        key.className = "key flex-1 h-8"; key.innerText = char; key.dataset.key = char;
                        // Corrected Mouse Event
                        key.onmousedown = () => { 
                            const inp = document.getElementById('cmd-input');
                            inp.value += char; inp.focus();
                            AudioSys.play('type');
                            key.classList.add('active');
                            setTimeout(()=>key.classList.remove('active'), 100);
                        };
                        r.appendChild(key);
                    });
                    k.appendChild(r);
                });
            },

            startGlobe() {
                const cvs = document.getElementById('globe-canvas');
                const ctx = cvs.getContext('2d');
                let t = 0;
                function loop() {
                    if(!cvs.parentElement) return;
                    cvs.width = cvs.parentElement.offsetWidth; cvs.height = cvs.parentElement.offsetHeight;
                    ctx.fillStyle = 'black'; ctx.fillRect(0,0,cvs.width,cvs.height);
                    t+=0.02; ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--accent');
                    const cx=cvs.width/2, cy=cvs.height/2;
                    for(let i=0; i<60; i++) {
                        const a = (i/60)*6.28 + t;
                        const x = Math.cos(a)*40; const y = Math.sin(a)*10;
                        ctx.beginPath(); ctx.arc(cx+x, cy+y, 1.5, 0, 6.28); ctx.fill();
                    }
                    requestAnimationFrame(loop);
                }
                loop();
            },

            openModal(id) { document.getElementById(id).style.display = 'flex'; },
            closeModal(id) { document.getElementById(id).style.display = 'none'; },
            setTheme(name) { 
                document.body.className = name; 
                localStorage.setItem('kaua_theme', name);
                this.closeModal('modal-settings');
            },
            
            toast(msg, type='info') {
                const c = document.getElementById('toast-container');
                const t = document.createElement('div');
                t.className = 'toast';
                const icon = type === 'success' ? 'check' : 'info';
                t.innerHTML = `<i data-lucide="${icon}" class="w-4 h-4"></i> ${msg}`;
                c.appendChild(t);
                lucide.createIcons();
                setTimeout(() => t.remove(), 3000);
            }
        };

        const Term = {
            print(msg, cls) { 
                const d = document.createElement('div'); d.className=cls; d.innerText=msg;
                const o = document.getElementById('term-out'); o.appendChild(d); o.scrollTop = o.scrollHeight; 
            }
        };

        // Key Listeners
        window.addEventListener('keydown', e => {
            const k = document.querySelector(`.key[data-key="${e.key.toUpperCase()}"]`);
            if(k) { k.classList.add('active'); setTimeout(()=>k.classList.remove('active'),150); AudioSys.play('type'); }
            
            if(e.key === 'Enter' && document.activeElement === document.getElementById('cmd-input')) {
                const val = document.getElementById('cmd-input').value;
                Term.print(`root:~$ ${val}`, 'cmd-line');
                const [cmd, arg] = val.split(' ');
                if(cmd === 'code') Canvas.open(arg);
                else if(cmd === 'ls') Object.keys(FS.files).forEach(f => Term.print(f, 'text-gray-400'));
                else if(cmd === 'help') Term.print("COMANDOS: code, ls, help, clear", "text-gray-400");
                else if(cmd === 'clear') document.getElementById('term-out').innerHTML = "";
                document.getElementById('cmd-input').value = '';
                AudioSys.play('type');
            }
        });

        // Loop Stats
        setInterval(() => {
            document.getElementById('clock').innerText = new Date().toLocaleTimeString();
            document.getElementById('cpu-val').innerText = Math.floor(Math.random()*30+10)+"%";
        }, 1000);

    </script>
</body>
</html>
